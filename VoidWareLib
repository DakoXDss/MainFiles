--[[
    Primordial Menu Library (Fixed & Upgraded)
    - Fixed: 'Indicator' invalid member crash
    - Added: Tabbed SubSections (General | Bars | Text style)
]]

local Library = {}
Library.__index = Library

-- Services
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")

-- Theme Configuration
local Theme = {
    Background = Color3.fromRGB(25, 25, 25),
    TopBar = Color3.fromRGB(35, 35, 35),
    SideBar = Color3.fromRGB(30, 30, 30),
    Section = Color3.fromRGB(40, 40, 40),
    Accent = Color3.fromRGB(255, 75, 75), -- The Primordial Red
    Text = Color3.fromRGB(255, 255, 255),
    TextDark = Color3.fromRGB(150, 150, 150),
    Border = Color3.fromRGB(20, 20, 20),
    SliderFill = Color3.fromRGB(255, 75, 75),
    ElementBack = Color3.fromRGB(30, 30, 30)
}

-- Utility Functions
local function CreateInstance(className, properties)
    local instance = Instance.new(className)
    for property, value in pairs(properties) do
        instance[property] = value
    end
    return instance
end

local function Tween(object, properties, duration)
    local tweenInfo = TweenInfo.new(duration or 0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    local tween = TweenService:Create(object, tweenInfo, properties)
    tween:Play()
    return tween
end

-- Main Library Constructor
function Library:New(config)
    local self = setmetatable({}, Library)
    
    config = config or {}
    self.Title = config.Title or "Primordial"
    self.Categories = {}
    self.CurrentCategory = nil
    self.CurrentTab = nil 
    
    self:CreateGUI()
    
    -- Default selection
    local defaultTab = self.BottomBar:FindFirstChild("Legit")
    if defaultTab then
        self:SelectTab(defaultTab)
    end
    
    return self
end

function Library:CreateGUI()
    self.GUI = CreateInstance("ScreenGui", {
        Name = "PrimordialMenu",
        Parent = game:GetService("CoreGui"),
        ZIndexBehavior = Enum.ZIndexBehavior.Sibling,
        ResetOnSpawn = false
    })
    
    self.MainFrame = CreateInstance("Frame", {
        Name = "MainFrame",
        Parent = self.GUI,
        BackgroundColor3 = Theme.Background,
        BorderSizePixel = 0,
        Position = UDim2.new(0.5, -350, 0.5, -250),
        Size = UDim2.new(0, 700, 0, 500),
        ClipsDescendants = true
    })
    
    CreateInstance("UICorner", {Parent = self.MainFrame, CornerRadius = UDim.new(0, 6)})

    -- Top Bar
    local topBar = CreateInstance("Frame", {
        Name = "TopBar",
        Parent = self.MainFrame,
        BackgroundColor3 = Theme.TopBar,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 50)
    })
    CreateInstance("UICorner", {Parent = topBar, CornerRadius = UDim.new(0, 6)})
    
    -- Fix corners for top bar (hide bottom rounded corners)
    local topBarCover = CreateInstance("Frame", {
        Parent = topBar,
        BackgroundColor3 = Theme.TopBar,
        BorderSizePixel = 0,
        Position = UDim2.new(0, 0, 1, -10),
        Size = UDim2.new(1, 0, 0, 10)
    })
    
    -- Logo
    local logo = CreateInstance("ImageLabel", {
        Name = "Logo",
        Parent = topBar,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 15, 0.5, -12),
        Size = UDim2.new(0, 24, 0, 24),
        Image = "rbxassetid://100788734994270" -- Primordial-ish logo
    })
    
    local title = CreateInstance("TextLabel", {
        Parent = topBar,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 45, 0, 0),
        Size = UDim2.new(0, 200, 1, 0),
        Font = Enum.Font.GothamBold,
        Text = self.Title,
        TextColor3 = Theme.Text,
        TextSize = 16,
        TextXAlignment = Enum.TextXAlignment.Left
    })
    
    -- Sidebar
    self.SideBar = CreateInstance("Frame", {
        Name = "SideBar",
        Parent = self.MainFrame,
        BackgroundColor3 = Theme.SideBar,
        BorderSizePixel = 0,
        Position = UDim2.new(0, 0, 0, 50),
        Size = UDim2.new(0, 180, 1, -100)
    })
    
    local sideList = CreateInstance("UIListLayout", {
        Parent = self.SideBar,
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 2)
    })
    
    CreateInstance("UIPadding", {
        Parent = self.SideBar,
        PaddingTop = UDim.new(0, 10),
        PaddingLeft = UDim.new(0, 10),
        PaddingRight = UDim.new(0, 10)
    })
    
    -- Content Frame
    self.ContentFrame = CreateInstance("Frame", {
        Name = "ContentFrame",
        Parent = self.MainFrame,
        BackgroundColor3 = Theme.Background,
        BorderSizePixel = 0,
        Position = UDim2.new(0, 180, 0, 50),
        Size = UDim2.new(1, -180, 1, -100),
        ClipsDescendants = true
    })
    
    -- Bottom Bar
    self.BottomBar = CreateInstance("Frame", {
        Name = "BottomBar",
        Parent = self.MainFrame,
        BackgroundColor3 = Theme.TopBar,
        BorderSizePixel = 0,
        Position = UDim2.new(0, 0, 1, -50),
        Size = UDim2.new(1, 0, 0, 50)
    })
    CreateInstance("UICorner", {Parent = self.BottomBar, CornerRadius = UDim.new(0, 6)})
    
    -- Cover top corners of bottom bar
    CreateInstance("Frame", {
        Parent = self.BottomBar,
        BackgroundColor3 = Theme.TopBar,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 10)
    })
    
    local bottomList = CreateInstance("UIListLayout", {
        Parent = self.BottomBar,
        FillDirection = Enum.FillDirection.Horizontal,
        HorizontalAlignment = Enum.HorizontalAlignment.Center,
        VerticalAlignment = Enum.VerticalAlignment.Center,
        Padding = UDim.new(0, 10)
    })
    
    -- Create Tabs
    local tabs = {"Rage", "Legit", "Visuals", "Misc", "Skins", "Scripts"}
    for i, name in ipairs(tabs) do
        local btn = CreateInstance("TextButton", {
            Name = name,
            Parent = self.BottomBar,
            BackgroundTransparency = 1,
            Size = UDim2.new(0, 80, 1, 0),
            Font = Enum.Font.GothamBold,
            Text = name,
            TextColor3 = Theme.TextDark,
            TextSize = 13
        })
        
        -- Indicator (Child of button)
        local ind = CreateInstance("Frame", {
            Name = "Indicator",
            Parent = btn,
            BackgroundColor3 = Theme.Accent,
            BorderSizePixel = 0,
            Position = UDim2.new(0.5, -15, 1, -4),
            Size = UDim2.new(0, 30, 0, 2),
            Visible = false
        })
        
        btn.MouseButton1Click:Connect(function()
            self:SelectTab(btn)
        end)
    end
    
    self:MakeDraggable(self.MainFrame, topBar)
end

function Library:SelectTab(tabBtn)
    if self.CurrentTab == tabBtn then return end
    
    -- Reset old tab
    if self.CurrentTab then
        self.CurrentTab.TextColor3 = Theme.TextDark
        local oldInd = self.CurrentTab:FindFirstChild("Indicator")
        if oldInd then oldInd.Visible = false end
    end
    
    -- Set new tab
    self.CurrentTab = tabBtn
    self.CurrentTab.TextColor3 = Theme.Text
    local newInd = self.CurrentTab:FindFirstChild("Indicator")
    if newInd then newInd.Visible = true end
    
    -- Update Categories
    local tabName = tabBtn.Name
    local firstCat = nil
    
    for _, cat in ipairs(self.Categories) do
        if cat.ParentTab == tabName then
            cat.Button.Visible = true
            if not firstCat then firstCat = cat end
        else
            cat.Button.Visible = false
            cat.Frame.Visible = false
            cat.Button.BackgroundColor3 = Theme.Section
            cat.Button.TextColor3 = Theme.TextDark
        end
    end
    
    if firstCat then
        self:SelectCategory(firstCat)
    end
end

function Library:MakeDraggable(frame, handle)
    local dragging, dragInput, dragStart, startPos
    
    handle.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then dragging = false end
            end)
        end
    end)
    
    handle.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then dragInput = input end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - dragStart
            frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
end

function Library:AddCategory(config)
    local name = config.Name or "Category"
    local parentTab = config.ParentTab or "Legit"
    
    local catBtn = CreateInstance("TextButton", {
        Name = name,
        Parent = self.SideBar,
        BackgroundColor3 = Theme.Section,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 35),
        Font = Enum.Font.GothamMedium,
        Text = name,
        TextColor3 = Theme.TextDark,
        TextSize = 13,
        Visible = false -- Hidden by default until tab selected
    })
    CreateInstance("UICorner", {Parent = catBtn, CornerRadius = UDim.new(0, 4)})
    
    local catFrame = CreateInstance("ScrollingFrame", {
        Name = name.."_Frame",
        Parent = self.ContentFrame,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 1, 0),
        CanvasSize = UDim2.new(0, 0, 0, 0),
        ScrollBarThickness = 2,
        Visible = false,
        AutomaticCanvasSize = Enum.AutomaticSize.Y
    })
    CreateInstance("UIListLayout", {Parent = catFrame, SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0, 10)})
    CreateInstance("UIPadding", {Parent = catFrame, PaddingTop = UDim.new(0,10), PaddingLeft = UDim.new(0,10), PaddingRight = UDim.new(0,10)})
    
    local category = {
        Name = name,
        ParentTab = parentTab,
        Button = catBtn,
        Frame = catFrame,
        Sections = {}
    }
    
    catBtn.MouseButton1Click:Connect(function()
        self:SelectCategory(category)
    end)
    
    table.insert(self.Categories, category)
    return setmetatable(category, {__index = self:GetCategoryMethods()})
end

function Library:SelectCategory(category)
    if self.CurrentCategory then
        self.CurrentCategory.Frame.Visible = false
        self.CurrentCategory.Button.BackgroundColor3 = Theme.Section
        self.CurrentCategory.Button.TextColor3 = Theme.TextDark
    end
    
    self.CurrentCategory = category
    category.Frame.Visible = true
    category.Button.BackgroundColor3 = Theme.ElementBack
    category.Button.TextColor3 = Theme.Text
end

function Library:GetCategoryMethods()
    local methods = {}
    
    function methods:AddSection(name)
        local sectionFrame = CreateInstance("Frame", {
            Name = name,
            Parent = self.Frame,
            BackgroundColor3 = Theme.Section,
            Size = UDim2.new(1, 0, 0, 0), -- Auto size
            AutomaticSize = Enum.AutomaticSize.Y
        })
        CreateInstance("UICorner", {Parent = sectionFrame, CornerRadius = UDim.new(0, 4)})
        
        local header = CreateInstance("Frame", {
            Parent = sectionFrame,
            BackgroundColor3 = Theme.TopBar,
            Size = UDim2.new(1, 0, 0, 30)
        })
        CreateInstance("UICorner", {Parent = header, CornerRadius = UDim.new(0, 4)})
        -- Cover bottom corners of header
        CreateInstance("Frame", {Parent = header, BackgroundColor3 = Theme.TopBar, BorderSizePixel = 0, Position = UDim2.new(0,0,1,-5), Size = UDim2.new(1,0,0,5)})
        
        CreateInstance("TextLabel", {
            Parent = header,
            BackgroundTransparency = 1,
            Position = UDim2.new(0, 10, 0, 0),
            Size = UDim2.new(1, -20, 1, 0),
            Font = Enum.Font.GothamBold,
            Text = name,
            TextColor3 = Theme.Text,
            TextSize = 12,
            TextXAlignment = Enum.TextXAlignment.Left
        })
        
        local container = CreateInstance("Frame", {
            Parent = sectionFrame,
            BackgroundTransparency = 1,
            Position = UDim2.new(0, 0, 0, 30),
            Size = UDim2.new(1, 0, 0, 0),
            AutomaticSize = Enum.AutomaticSize.Y
        })
        CreateInstance("UIListLayout", {Parent = container, SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0, 5)})
        CreateInstance("UIPadding", {Parent = container, PaddingTop = UDim.new(0,10), PaddingBottom = UDim.new(0,10), PaddingLeft = UDim.new(0,10), PaddingRight = UDim.new(0,10)})
        
        return setmetatable({Container = container}, {__index = Library:GetElementMethods()})
    end
    
    return methods
end

function Library:GetElementMethods()
    local methods = {}
    
    -- TABBED SECTION (Fix for your screenshot requirement)
    function methods:AddTabbedSection(tabNames)
        local holder = CreateInstance("Frame", {
            Parent = self.Container,
            BackgroundColor3 = Theme.ElementBack,
            Size = UDim2.new(1, 0, 0, 0),
            AutomaticSize = Enum.AutomaticSize.Y,
            BackgroundTransparency = 1
        })
        
        -- Tab Bar
        local tabBar = CreateInstance("Frame", {
            Parent = holder,
            BackgroundColor3 = Color3.fromRGB(0,0,0),
            BackgroundTransparency = 0.5,
            Size = UDim2.new(1, 0, 0, 25)
        })
        CreateInstance("UICorner", {Parent = tabBar, CornerRadius = UDim.new(0, 4)})
        CreateInstance("UIListLayout", {Parent = tabBar, FillDirection = Enum.FillDirection.Horizontal, HorizontalAlignment = Enum.HorizontalAlignment.Center})
        
        local contentHolder = CreateInstance("Frame", {
            Parent = holder,
            BackgroundTransparency = 1,
            Size = UDim2.new(1, 0, 0, 0),
            AutomaticSize = Enum.AutomaticSize.Y,
            Position = UDim2.new(0, 0, 0, 30)
        })
        
        local tabs = {}
        local currentTabBtn = nil
        
        local function Switch(name)
            for _, t in pairs(tabs) do
                if t.Name == name then
                    t.Frame.Visible = true
                    t.Btn.TextColor3 = Theme.Accent
                else
                    t.Frame.Visible = false
                    t.Btn.TextColor3 = Theme.TextDark
                end
            end
        end
        
        local tabMethods = {}
        
        function tabMethods:AddTab(name)
            -- Tab Button
            local btn = CreateInstance("TextButton", {
                Parent = tabBar,
                BackgroundTransparency = 1,
                Size = UDim2.new(1 / #tabNames, 0, 1, 0), -- Rough auto width
                Font = Enum.Font.GothamBold,
                Text = name,
                TextColor3 = Theme.TextDark,
                TextSize = 11
            })
            
            -- Tab Content
            local frame = CreateInstance("Frame", {
                Parent = contentHolder,
                BackgroundTransparency = 1,
                Size = UDim2.new(1, 0, 0, 0),
                AutomaticSize = Enum.AutomaticSize.Y,
                Visible = false
            })
            CreateInstance("UIListLayout", {Parent = frame, SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0, 5)})
            
            table.insert(tabs, {Name = name, Btn = btn, Frame = frame})
            
            btn.MouseButton1Click:Connect(function() Switch(name) end)
            
            -- Select first by default
            if #tabs == 1 then Switch(name) end
            
            return setmetatable({Container = frame}, {__index = Library:GetElementMethods()})
        end
        
        return tabMethods
    end

    function methods:AddToggle(name, default, callback)
        default = default or false
        callback = callback or function() end
        
        local btn = CreateInstance("TextButton", {
            Name = "Toggle",
            Parent = self.Container,
            BackgroundTransparency = 1,
            Size = UDim2.new(1, 0, 0, 20),
            Text = ""
        })
        
        local check = CreateInstance("Frame", {
            Parent = btn,
            BackgroundColor3 = Theme.ElementBack,
            Size = UDim2.new(0, 16, 0, 16),
            Position = UDim2.new(0, 0, 0.5, -8)
        })
        CreateInstance("UICorner", {Parent = check, CornerRadius = UDim.new(0, 3)})
        
        local fill = CreateInstance("Frame", {
            Parent = check,
            BackgroundColor3 = Theme.Accent,
            Size = UDim2.new(0, 10, 0, 10),
            Position = UDim2.new(0.5, -5, 0.5, -5),
            Visible = default
        })
        CreateInstance("UICorner", {Parent = fill, CornerRadius = UDim.new(0, 2)})
        
        local lbl = CreateInstance("TextLabel", {
            Parent = btn,
            BackgroundTransparency = 1,
            Position = UDim2.new(0, 25, 0, 0),
            Size = UDim2.new(1, -25, 1, 0),
            Font = Enum.Font.Gotham,
            Text = name,
            TextColor3 = Theme.Text,
            TextSize = 12,
            TextXAlignment = Enum.TextXAlignment.Left
        })
        
        local active = default
        btn.MouseButton1Click:Connect(function()
            active = not active
            fill.Visible = active
            callback(active)
        end)
    end
    
    function methods:AddColorPicker(name, default, callback)
        default = default or Color3.new(1,1,1)
        callback = callback or function() end
        
        local frame = CreateInstance("Frame", {
            Parent = self.Container,
            BackgroundTransparency = 1,
            Size = UDim2.new(1, 0, 0, 20)
        })
        
        local lbl = CreateInstance("TextLabel", {
            Parent = frame,
            BackgroundTransparency = 1,
            Size = UDim2.new(0.7, 0, 1, 0),
            Font = Enum.Font.Gotham,
            Text = name,
            TextColor3 = Theme.Text,
            TextSize = 12,
            TextXAlignment = Enum.TextXAlignment.Left
        })
        
        local colorBtn = CreateInstance("TextButton", {
            Parent = frame,
            BackgroundColor3 = default,
            Size = UDim2.new(0, 30, 0, 14),
            Position = UDim2.new(1, -30, 0.5, -7),
            Text = ""
        })
        CreateInstance("UICorner", {Parent = colorBtn, CornerRadius = UDim.new(0, 2)})
        
        -- Simple click to randomize (Color picker UI is very complex for single script)
        colorBtn.MouseButton1Click:Connect(function()
            local r, g, b = math.random(), math.random(), math.random()
            local c = Color3.new(r,g,b)
            colorBtn.BackgroundColor3 = c
            callback(c)
        end)
    end
    
    return methods
end
